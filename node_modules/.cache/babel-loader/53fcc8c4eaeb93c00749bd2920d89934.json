{"ast":null,"code":"// [VexFlow](http://vexflow.com) - Copyright (c) Mohit Muthanna 2010.\n//\n// ## Description\n//\n// This class implements diatonic key management.\nimport { Vex } from './vex';\nimport { Music } from './music';\nexport class KeyManager {\n  constructor(key) {\n    this.music = new Music();\n    this.setKey(key);\n  }\n\n  setKey(key) {\n    this.key = key;\n    this.reset();\n    return this;\n  }\n\n  getKey() {\n    return this.key;\n  }\n\n  reset() {\n    this.keyParts = this.music.getKeyParts(this.key);\n    this.keyString = this.keyParts.root;\n    if (this.keyParts.accidental) this.keyString += this.keyParts.accidental;\n    const is_supported_type = Music.scaleTypes[this.keyParts.type];\n\n    if (!is_supported_type) {\n      throw new Vex.RERR('BadArguments', `Unsupported key type: ${this.key}`);\n    }\n\n    this.scale = this.music.getScaleTones(this.music.getNoteValue(this.keyString), Music.scaleTypes[this.keyParts.type]);\n    this.scaleMap = {};\n    this.scaleMapByValue = {};\n    this.originalScaleMapByValue = {};\n    const noteLocation = Music.root_indices[this.keyParts.root];\n\n    for (let i = 0; i < Music.roots.length; ++i) {\n      const index = (noteLocation + i) % Music.roots.length;\n      const rootName = Music.roots[index];\n      const noteName = this.music.getRelativeNoteName(rootName, this.scale[i]);\n      this.scaleMap[rootName] = noteName;\n      this.scaleMapByValue[this.scale[i]] = noteName;\n      this.originalScaleMapByValue[this.scale[i]] = noteName;\n    }\n\n    return this;\n  }\n\n  getAccidental(key) {\n    const root = this.music.getKeyParts(key).root;\n    const parts = this.music.getNoteParts(this.scaleMap[root]);\n    return {\n      note: this.scaleMap[root],\n      accidental: parts.accidental\n    };\n  }\n\n  selectNote(note) {\n    note = note.toLowerCase();\n    const parts = this.music.getNoteParts(note); // First look for matching note in our altered scale\n\n    const scaleNote = this.scaleMap[parts.root];\n    const modparts = this.music.getNoteParts(scaleNote);\n\n    if (scaleNote === note) {\n      return {\n        'note': scaleNote,\n        'accidental': parts.accidental,\n        'change': false\n      };\n    } // Then search for a note of equivalent value in our altered scale\n\n\n    const valueNote = this.scaleMapByValue[this.music.getNoteValue(note)];\n\n    if (valueNote != null) {\n      return {\n        'note': valueNote,\n        'accidental': this.music.getNoteParts(valueNote).accidental,\n        'change': false\n      };\n    } // Then search for a note of equivalent value in the original scale\n\n\n    const originalValueNote = this.originalScaleMapByValue[this.music.getNoteValue(note)];\n\n    if (originalValueNote != null) {\n      this.scaleMap[modparts.root] = originalValueNote;\n      delete this.scaleMapByValue[this.music.getNoteValue(scaleNote)];\n      this.scaleMapByValue[this.music.getNoteValue(note)] = originalValueNote;\n      return {\n        'note': originalValueNote,\n        'accidental': this.music.getNoteParts(originalValueNote).accidental,\n        'change': true\n      };\n    } // Then try to unmodify a currently modified note.\n\n\n    if (modparts.root === note) {\n      delete this.scaleMapByValue[this.music.getNoteValue(this.scaleMap[parts.root])];\n      this.scaleMapByValue[this.music.getNoteValue(modparts.root)] = modparts.root;\n      this.scaleMap[modparts.root] = modparts.root;\n      return {\n        'note': modparts.root,\n        'accidental': null,\n        'change': true\n      };\n    } // Last resort -- shitshoot\n\n\n    delete this.scaleMapByValue[this.music.getNoteValue(this.scaleMap[parts.root])];\n    this.scaleMapByValue[this.music.getNoteValue(note)] = note;\n    delete this.scaleMap[modparts.root];\n    this.scaleMap[modparts.root] = note;\n    return {\n      note,\n      'accidental': parts.accidental,\n      'change': true\n    };\n  }\n\n}","map":{"version":3,"sources":["/Users/adamsarli/Coding/music-app/node_modules/vexflow/src/keymanager.js"],"names":["Vex","Music","KeyManager","constructor","key","music","setKey","reset","getKey","keyParts","getKeyParts","keyString","root","accidental","is_supported_type","scaleTypes","type","RERR","scale","getScaleTones","getNoteValue","scaleMap","scaleMapByValue","originalScaleMapByValue","noteLocation","root_indices","i","roots","length","index","rootName","noteName","getRelativeNoteName","getAccidental","parts","getNoteParts","note","selectNote","toLowerCase","scaleNote","modparts","valueNote","originalValueNote"],"mappings":"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","sourcesContent":["// [VexFlow](http://vexflow.com) - Copyright (c) Mohit Muthanna 2010.\n//\n// ## Description\n//\n// This class implements diatonic key management.\n\nimport { Vex } from './vex';\nimport { Music } from './music';\n\nexport class KeyManager {\n  constructor(key) {\n    this.music = new Music();\n    this.setKey(key);\n  }\n\n  setKey(key) {\n    this.key = key;\n    this.reset();\n    return this;\n  }\n\n  getKey() { return this.key; }\n\n  reset() {\n    this.keyParts = this.music.getKeyParts(this.key);\n\n    this.keyString = this.keyParts.root;\n    if (this.keyParts.accidental) this.keyString += this.keyParts.accidental;\n\n    const is_supported_type = Music.scaleTypes[this.keyParts.type];\n    if (!is_supported_type) {\n      throw new Vex.RERR('BadArguments', `Unsupported key type: ${this.key}`);\n    }\n\n    this.scale = this.music.getScaleTones(\n      this.music.getNoteValue(this.keyString),\n      Music.scaleTypes[this.keyParts.type]\n    );\n\n    this.scaleMap = {};\n    this.scaleMapByValue = {};\n    this.originalScaleMapByValue = {};\n\n    const noteLocation = Music.root_indices[this.keyParts.root];\n\n    for (let i = 0; i < Music.roots.length; ++i) {\n      const index = (noteLocation + i) % Music.roots.length;\n      const rootName = Music.roots[index];\n\n      const noteName = this.music.getRelativeNoteName(rootName, this.scale[i]);\n      this.scaleMap[rootName] = noteName;\n      this.scaleMapByValue[this.scale[i]] = noteName;\n      this.originalScaleMapByValue[this.scale[i]] = noteName;\n    }\n\n    return this;\n  }\n\n  getAccidental(key) {\n    const root = this.music.getKeyParts(key).root;\n    const parts = this.music.getNoteParts(this.scaleMap[root]);\n\n    return {\n      note: this.scaleMap[root],\n      accidental: parts.accidental,\n    };\n  }\n\n  selectNote(note) {\n    note = note.toLowerCase();\n    const parts = this.music.getNoteParts(note);\n\n    // First look for matching note in our altered scale\n    const scaleNote = this.scaleMap[parts.root];\n    const modparts = this.music.getNoteParts(scaleNote);\n\n    if (scaleNote === note) {\n      return {\n        'note': scaleNote,\n        'accidental': parts.accidental,\n        'change': false,\n      };\n    }\n\n    // Then search for a note of equivalent value in our altered scale\n    const valueNote = this.scaleMapByValue[this.music.getNoteValue(note)];\n    if (valueNote != null) {\n      return {\n        'note': valueNote,\n        'accidental': this.music.getNoteParts(valueNote).accidental,\n        'change': false,\n      };\n    }\n\n    // Then search for a note of equivalent value in the original scale\n    const originalValueNote = this.originalScaleMapByValue[\n      this.music.getNoteValue(note)];\n    if (originalValueNote != null) {\n      this.scaleMap[modparts.root] = originalValueNote;\n      delete this.scaleMapByValue[this.music.getNoteValue(scaleNote)];\n      this.scaleMapByValue[this.music.getNoteValue(note)] = originalValueNote;\n      return {\n        'note': originalValueNote,\n        'accidental': this.music.getNoteParts(originalValueNote).accidental,\n        'change': true,\n      };\n    }\n\n    // Then try to unmodify a currently modified note.\n    if (modparts.root === note) {\n      delete this.scaleMapByValue[this.music.getNoteValue(this.scaleMap[parts.root])];\n      this.scaleMapByValue[this.music.getNoteValue(modparts.root)] =  modparts.root;\n      this.scaleMap[modparts.root] = modparts.root;\n      return {\n        'note': modparts.root,\n        'accidental': null,\n        'change': true,\n      };\n    }\n\n    // Last resort -- shitshoot\n    delete this.scaleMapByValue[this.music.getNoteValue(this.scaleMap[parts.root])];\n    this.scaleMapByValue[this.music.getNoteValue(note)] = note;\n\n    delete this.scaleMap[modparts.root];\n    this.scaleMap[modparts.root] = note;\n\n    return {\n      note,\n      'accidental': parts.accidental,\n      'change': true,\n    };\n  }\n}\n"]},"metadata":{},"sourceType":"module"}